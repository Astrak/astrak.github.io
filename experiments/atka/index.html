<!DOCTYPE html>
<html>
	<head>
		<title>Atka</title>
		<meta name='theme-color' content='#444'/>
		<meta name='viewport' content='width=device-width, user-scalable=no'/>
		<style>
			body{
			    margin:0;
			    overflow:hidden;
			}
			canvas{
				cursor:grab;
				cursor:-webkit-grab;
				cursor:-moz-grab;
			}
			canvas:active{
				cursor:grabbing;
				cursor:-webkit-grabbing;
				cursor:-moz-grabbing;
			}
			#container {
				position: absolute;
				top:0;left:0;
				padding:10px;
				background:#333;
			}
			#adder {
				color:#bbb;
				background:#555;
			}
			#info {
				position:absolute;
				top:0;right:0;
				background:#000;
				color:#00ff00;
			}
		</style>
	</head>
	<body>

		<script src='../../js/threer76.js'></script>
		<script src='../../js/controls/OrbitControlsr76.js'></script>

		<script>
			'use strict';
			
			var scene, renderer, camera, controls;
			var targetVector = new THREE.Vector3();
			var tangage = new THREE.Vector3();
			var cameraOffset = new THREE.Vector3(0,-.2,0);
			var raycaster, mouse = { x : 0, y : 0 };
			var tLoader = new THREE.TextureLoader();
			var jLoader = new THREE.JSONLoader();
			var earth, helper, ship;
			var info, total;
			var shipPosition = 0;
			var curve, 
				geometry, 
				material = new THREE.MeshBasicMaterial({
					color:0x0066ff,
					transparent:true,
					opacity:.5
				}), 
				spline, 
				points = [
				new THREE.Vector3(0.69968, 0.72745, 0.01922),new THREE.Vector3(0.61960, 0.78724, 0.12542),new THREE.Vector3(0.48179, 0.87984, 0.11349),new THREE.Vector3(0.32782, 0.95386, 0.04530),new THREE.Vector3(0.27787, 0.95693, -0.16352),new THREE.Vector3(0.29382, 0.94460, -0.20292),new THREE.Vector3(0.24178, 0.93778, -0.28539),new THREE.Vector3(0.16693, 0.95539, -0.28070),new THREE.Vector3(0.10989, 0.97228, -0.24989),new THREE.Vector3(0.05314, 0.96790, -0.28245),new THREE.Vector3(0.04302, 0.99065, -0.19077),new THREE.Vector3(0.06740, 0.99591, -0.15249),new THREE.Vector3(0.03287, 0.99638, -0.16038),new THREE.Vector3(-0.01173, 0.99061, -0.19529),new THREE.Vector3(-0.03549, 0.98659, -0.21227),new THREE.Vector3(-0.10699, 0.98351, -0.20281),new THREE.Vector3(-0.10212, 0.97832, -0.22801),new THREE.Vector3(-0.18225, 0.96968, -0.21454),new THREE.Vector3(-0.15001, 0.98595, -0.15886),new THREE.Vector3(-0.23128, 0.97766, -0.10092),new THREE.Vector3(-0.33804, 0.94727, -0.09078),new THREE.Vector3(-0.33033, 0.95419, 0.00029),new THREE.Vector3(-0.40545, 0.92125, 0.07955),new THREE.Vector3(-0.47856, 0.88910, -0.01294),new THREE.Vector3(-0.52997, 0.84657, -0.14890),new THREE.Vector3(-0.59296, 0.77725, -0.25110),new THREE.Vector3(-0.44801, 0.86442, -0.26823),new THREE.Vector3(-0.41500, 0.85977, -0.32815),new THREE.Vector3(-0.52779, 0.77095, -0.38298),new THREE.Vector3(-0.59367, 0.72228, -0.38037),new THREE.Vector3(-0.58851, 0.76783, -0.28903),new THREE.Vector3(-0.56239, 0.82732, -0.13503),new THREE.Vector3(-0.61681, 0.79818, -0.03807),new THREE.Vector3(-0.60233, 0.80449, 0.09498),new THREE.Vector3(-0.52587, 0.84226, 0.18338),new THREE.Vector3(-0.48720, 0.87569, 0.12259),new THREE.Vector3(-0.41092, 0.91819, 0.08591),new THREE.Vector3(-0.38545, 0.92554, 0.11966),new THREE.Vector3(-0.35180, 0.94315, 0.07925),new THREE.Vector3(-0.28909, 0.95876, 0.13005),new THREE.Vector3(-0.26243, 0.94686, 0.23332),new THREE.Vector3(-0.20871, 0.95288, 0.26084),new THREE.Vector3(-0.14878, 0.93921, 0.33951),new THREE.Vector3(-0.07373, 0.93908, 0.36343),new THREE.Vector3(-0.03405, 0.95787, 0.31772),new THREE.Vector3(-0.03304, 0.97127, 0.27434),new THREE.Vector3(0.05630, 0.97031, 0.27372),new THREE.Vector3(0.13298, 0.95075, 0.31307),new THREE.Vector3(0.19329, 0.92882, 0.34616),new THREE.Vector3(0.19544, 0.90423, 0.40429),new THREE.Vector3(0.36491, 0.86712, 0.36697),new THREE.Vector3(0.53720, 0.81414, 0.26146),new THREE.Vector3(0.63372, 0.76783, 0.16790),new THREE.Vector3(0.70288, 0.72422, 0.01981)
				], 
				point = new THREE.Vector3();
			var shape = new THREE.Shape( new THREE.CircleGeometry( .001, 5 ).vertices );
			var sun, h;
			
			setScene();
			animate();

			function setScene(){
				renderer = new THREE.WebGLRenderer();
				renderer.setSize( innerWidth, innerHeight );
				document.body.appendChild( renderer.domElement );
				scene = new THREE.Scene();

				earth = new THREE.Mesh(
					new THREE.SphereBufferGeometry( 1, 70, 70 ),
					new THREE.MeshLambertMaterial({
						map : tLoader.load( '../planet/MR.jpg', function () { camera.update = true; })
					})
				);

				helper = new THREE.Mesh(
					new THREE.SphereBufferGeometry( .01, 10, 10 ),
					new THREE.MeshBasicMaterial({
						color:0xffff00
					}));


				scene.add( earth, helper );

				//addLogger();

				setLighting();

				setView();

				addShip();

				//setRaycaster();
			}

			function addShip () {
				jLoader.load( 'model.json', function ( g ) {
					addPath();
					addInfo();
					ship = new THREE.Mesh(
						g, 
						new THREE.MeshLambertMaterial({
							color:0x8888aa,
							side:THREE.DoubleSide
						}));
					ship.scale.set(.005,.005,.005);
					ship.castShadow = ship.receiveShadow = earth.receiveShadow = true;
					scene.add( ship );
				});
			}

			function addInfo () {
				info = document.createElement( 'p' );
				info.id = 'info';
				document.body.appendChild( info );
				total = curve.getLength() * 6357;
			}

			function setLighting () {
				var ambient = new THREE.AmbientLight( 0x555555 );
				sun = new THREE.DirectionalLight( 0xffffff, 1, 10 );
				sun.position.z = 2;
				h = new THREE.DirectionalLightHelper(sun,0xffffff);
				scene.add( ambient, sun);

				sun.shadow.mapSize.set( 1024, 1024 );
				sun.shadow.camera.right = 1;
				sun.shadow.camera.left = -1;
				sun.shadow.camera.top = 1;
				sun.shadow.camera.bottom = -1;

				sun.castShadow = renderer.shadowMap.enabled = true;
			}

			function setView () {
				camera = new THREE.PerspectiveCamera( 50, innerWidth / innerHeight, .001, 10 );
				camera.position.z = 3;
				camera.update = false;

				controls = new THREE.OrbitControls( camera, renderer.domElement );
				controls.addEventListener( 'change', function () { camera.update = true; });
				controls.enableDamping = true;
				controls.dampingFactor = .05;
				controls.rotateSpeed = .07;
				controls.maxPolarAngle = 2;

				window.addEventListener( 'resize', function () {
					camera.aspect = innerWidth / innerHeight;
					camera.updateProjectionMatrix();
					renderer.setSize( innerWidth, innerHeight );
					camera.update = true;
				}, false );
			}

			function addPath () {
				curve = new THREE.CatmullRomCurve3( points );
				curve.type = "catmullrom";
				geometry = new THREE.ExtrudeGeometry( shape, { 
					steps : 2000, 
					bevelEnabled : false,
					extrudePath : curve
				});
				spline = new THREE.Mesh( geometry, material );
				scene.add( spline );
				camera.update = true;		
			}

			function addLogger () {
				var div = document.createElement( 'div' );
				div.id = 'container';
				document.body.appendChild( div );

				var button = document.createElement( 'button' );
				button.id = 'adder';
				button.innerHTML = 'Add';
				div.appendChild( button );

				button.addEventListener( 'click', function () {
					if ( point.length() ) {
						points.push( point.clone() );
						if ( points.length > 1 ) {
							curve = new THREE.CatmullRomCurve3( points );
							curve.type = 'catmullrom';
							scene.remove( spline );
							spline = null;
							geometry = new THREE.ExtrudeGeometry( shape, { 
								steps : 1000, 
								bevelEnabled : false,
								extrudePath : curve
							});
							spline = new THREE.Mesh( geometry, material );
							scene.add( spline );
							camera.update = true;
						}
					}
				}, false );
			}

			function setRaycaster () {
				raycaster = new THREE.Raycaster();
				renderer.domElement.addEventListener('click', raycast, false);
			}

			function raycast ( e ) {
				mouse.x = ( e.clientX / window.innerWidth ) * 2 - 1;
				mouse.y = - ( e.clientY / window.innerHeight ) * 2 + 1;	
				raycaster.setFromCamera( mouse, camera );	

				var intersects = raycaster.intersectObjects( scene.children );

				for ( var i = 0; i < intersects.length; i++ )
					if ( intersects[ i ].object === earth ) {
						point.copy( intersects[ i ].point ).multiplyScalar( 1.01 );
						helper.position.copy( point );
						camera.update = true;
					}
			}

			function animate () {
				requestAnimationFrame(animate);
				controls.update();
				if ( ship !== undefined ) {
					shipPosition+=.0001;
					ship.position.copy( curve.getPointAt( shipPosition ) );
					targetVector.copy( curve.getPointAt( shipPosition + .0001 ) ).normalize();
					ship.up.copy( ship.position ).normalize();
					camera.up.copy( ship.up );
					tangage.crossVectors( targetVector, ship.up ).setLength( .1 * Math.cos( shipPosition * 300 ) );
					ship.up.add( tangage ).normalize();
					ship.lookAt( curve.getPointAt( shipPosition + .0001 ) );
					sun.position.copy( ship.position ).setLength(1.5);//.add( tangage.setLength( .01 ) );
					sun.lookAt( ship.position );
					camera.position.copy(ship.position).add( cameraOffset ).setLength( 1.4 );
					camera.lookAt( ship.position );
					camera.update = true;
					info.innerHTML = (shipPosition * total).toFixed(0) + 'km';
				}
				if ( camera.update ) {
					renderer.render( scene, camera );
					camera.update = false;
				}
			}
		</script>
	</body>
</html> 